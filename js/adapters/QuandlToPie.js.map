{"version":3,"sources":["../../src/adapters/QuandlToPie.js"],"names":["_fnCalcPieLegendHeight","length","HEIGHT","LEGEND_ROW_HEIGHT","Math","ceil","_fnAddPercentToItem","item","bTotal","_bPercent","createPercent","bValue","y","gte","name","_fnCreateTopDonutData","data","isPercent","arr","_bTotal90","times","bArrTotal","i","max","push","plus","eq","minus","nameFull","color","parseFloat","fCreatePieConfig","json","option","fBasePieConfig","sliceItems","items","value","zhSeriaId","SEMI_DONUT","jsonData","dataset","jsonData1","jsonData2","_year1","split","_year2","_data1","_data2","_bTotal1","_bTotal2","forEach","index","y1","y2","_name","caption","substring","_dataTop1","sort","compareByY","reverse","_dataTop2","config","series","fInnerPieSeria","center","year","fnNumberFormat","fOuterPieSeria","isShowInLegend","setTitleToConfig","Object","assign","chart","height","valueMoving","zhConfig","info","createDatasetInfo"],"mappings":"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","file":"QuandlToPie.js","sourcesContent":["\r\nimport Big from 'big.js';\r\n\r\nimport AdapterFn from './AdapterFn';\r\nimport { ChartType } from '../constants/Type';\r\nimport Chart from '../charts/Chart';\r\nimport ChartConfig from '../charts/ChartConfig';\r\n\r\nimport QuandlFn2 from './QuandlFn2';\r\nimport { crValueMoving, crZhConfig } from './StackedFn';\r\n\r\nconst _fnCalcPieLegendHeight = function(length){\r\n  if (length !== 0){\r\n    return Chart.HEIGHT + Chart.LEGEND_ROW_HEIGHT*(Math.ceil(length / 4) - 1);\r\n  } else {\r\n    return Chart.HEIGHT;\r\n  }\r\n}\r\n\r\nconst _fnAddPercentToItem = function(item, bTotal){\r\n  const _bPercent = QuandlFn2.createPercent({ bValue : Big(item.y), bTotal: bTotal});\r\n  if (Big(_bPercent).gte('10.00')) {\r\n     item.name = item.name + ' ' + _bPercent;\r\n  } else {\r\n     item.name = item.name + '  ' + _bPercent;\r\n  }\r\n}\r\n\r\nconst _fnCreateTopDonutData = function({\r\n  data=[], bTotal=Big('0.0'), isPercent=false\r\n}){\r\n  const arr = []\r\n      , _bTotal90 = bTotal.times(0.9);\r\n  let bArrTotal = Big('0.0');\r\n  for (let i=0, max=data.length; i<max; i++ ){\r\n    let item = data[i];\r\n    if ( i === 0 ||\r\n         !bArrTotal.gte(_bTotal90) ||\r\n         i === max-1 )\r\n    {\r\n      if (isPercent) {\r\n        _fnAddPercentToItem(item, bTotal);\r\n      }\r\n      arr.push(item);\r\n    } else { break; }\r\n\r\n    bArrTotal = bArrTotal.plus(item.y);\r\n  }\r\n  if (!bArrTotal.eq(bTotal)) {\r\n    bArrTotal = bTotal.minus(bArrTotal);\r\n    arr.push({\r\n      name : 'Other ' + QuandlFn2.createPercent({ bValue: bArrTotal, bTotal: bTotal}),\r\n      nameFull : 'Other',\r\n      color : 'gray',\r\n      y : parseFloat(bArrTotal)\r\n    })\r\n  }\r\n  return arr;\r\n}\r\n\r\nexport const fCreatePieConfig = function(json, option){\r\n   const config = ChartConfig.fBasePieConfig()\r\n       , {sliceItems:items=[], value=''} = option\r\n       , zhSeriaId = `${value}_${ChartType.SEMI_DONUT}`\r\n       , jsonData = (json.dataset && json.dataset.data) ? json.dataset.data : []\r\n       , jsonData1 = jsonData[0]\r\n       , jsonData2 = jsonData[1]\r\n       , _year1 = (jsonData1[0]) ? jsonData1[0].split('-')[0] : ''\r\n       , _year2 = (jsonData2[0]) ? jsonData2[0].split('-')[0] : ''\r\n       , _data1 = []\r\n       , _data2 = [];\r\n\r\n   let _bTotal1 = Big('0.0');\r\n   let _bTotal2 = Big('0.0');\r\n\r\n\r\n   items.forEach((item, index) =>{\r\n       let y1 = jsonData1[item.value];\r\n       let y2 = jsonData2[item.value];\r\n       if (y1){\r\n         //const _nameFull = item.caption.replace(/;/g, '<br/>')\r\n         const _name = item.caption.split(';')[0].substring(0, 9);\r\n         _data1.push({name : _name, nameFull: item.caption, y: y1});\r\n         _bTotal1 = _bTotal1.plus(y1);\r\n       }\r\n       if (y2){\r\n         _data2.push({nameFull: item.caption, y: y2});\r\n         _bTotal2 = _bTotal2.plus(y2);\r\n       }\r\n   });\r\n\r\n   const _dataTop1 = _fnCreateTopDonutData({\r\n     data: _data1.sort(AdapterFn.compareByY).reverse(),\r\n     bTotal : _bTotal1,\r\n     isPercent : true\r\n   });\r\n   const _dataTop2 = _fnCreateTopDonutData({\r\n     data: _data2.sort(AdapterFn.compareByY).reverse(),\r\n     bTotal: _bTotal2\r\n   });\r\n\r\n   config.series = [\r\n      ChartConfig.fInnerPieSeria({\r\n       center : ['20%', '80%'],\r\n       year : _year1,\r\n       bTotal : ChartConfig.fnNumberFormat(_bTotal1)\r\n      })\r\n    , ChartConfig.fOuterPieSeria({\r\n        zhSeriaId : zhSeriaId,\r\n        center  : ['20%', '80%'],\r\n        data : _dataTop1,\r\n        isShowInLegend : true\r\n      })\r\n    , ChartConfig.fInnerPieSeria({\r\n        center : ['70%', '80%'],\r\n        year : _year2,\r\n        bTotal : ChartConfig.fnNumberFormat(_bTotal2)\r\n      })\r\n    , ChartConfig.fOuterPieSeria({\r\n        zhSeriaId : zhSeriaId,\r\n        center  : ['70%', '80%'],\r\n        data : _dataTop2\r\n     })\r\n   ];\r\n\r\n   QuandlFn2.setTitleToConfig(config, option);\r\n\r\n   Object.assign(config, {\r\n     chart: {\r\n       height: _fnCalcPieLegendHeight(_dataTop1.length)\r\n     },\r\n     valueMoving: crValueMoving(_bTotal1, _year1, _bTotal2, _year2),\r\n     zhConfig: crZhConfig(option, zhSeriaId),\r\n     info: QuandlFn2.createDatasetInfo(json)\r\n   })\r\n\r\n   return { config };\r\n}\r\n"]}